Below is the enhanced English version of the document, incorporating the requested sections: **Adjustment Plan**, **Resource List**, **Adjustment Steps**, **Validation Methods**, and **Notes**. The content is structured to be clear, professional, and suitable for inclusion in your documentation.

---

**Adjusting MIG Instance Count to Support Rolling Upgrades and Adding Share VPC IP to Firewall Whitelist**

In the current Google Cloud Platform (GCP) production environment, some Managed Instance Groups (MIGs) have insufficient instance counts to support rolling upgrades, leading to downtime during image refresh operations. To address this, we plan to adjust the MIG instance count to ensure sufficient instances are available for seamless rolling upgrades, minimizing or eliminating service interruptions. Additionally, new Share VPC IP addresses generated during this process must be added to the firewall whitelist to maintain network connectivity and security.

### Adjustment Plan
The adjustment plan aims to increase the MIG instance count to support rolling upgrades and ensure new Share VPC IPs are properly integrated into the network configuration. The plan includes:
- Assessing the current MIG configuration to determine the required instance count.
- Scaling the MIG to meet rolling upgrade requirements without impacting service availability.
- Identifying and adding new Share VPC IPs to the firewall whitelist.
- Validating the adjustments to ensure no downtime and proper functionality.

### Resource List
The following resources are required for the adjustment:
- **GCP Project**: [Specify project ID, e.g., `my-production-project`].
- **MIGs**: List of target MIGs [e.g., `mig-webapp-prod`, `mig-api-prod`].
- **Load Balancer**: Associated load balancer [e.g., `prod-load-balancer`].
- **Firewall Rules**: Existing firewall rules to be updated [e.g., `allow-http-https`].
- **Network Configuration**: Share VPC details [e.g., `shared-vpc-prod`].
- **Tools**: 
  - GCP Console or `gcloud` CLI for MIG and firewall management.
  - Monitoring tools [e.g., Google Cloud Monitoring, Logging].
- **Personnel**: 
  - Cloud engineering team to adjust MIGs.
  - Network team to update firewall rules.

### Adjustment Steps
1. **Assess Current MIG Configuration**:
   - Use `gcloud compute instance-groups managed describe [MIG_NAME]` to review the current instance count, autoscaling policies, and rolling update settings.
   - Determine the minimum number of instances required to support rolling upgrades based on the maximum unavailable percentage (e.g., 10%) and replacement rate.
2. **Update MIG Instance Count**:
   - Adjust the MIG target size using `gcloud compute instance-groups managed set-target-size [MIG_NAME] --size [NEW_SIZE]` or via the GCP Console.
   - Configure the rolling update policy to ensure gradual instance replacement (e.g., `maxSurge` and `maxUnavailable` settings).
3. **Identify New Share VPC IPs**:
   - Monitor the MIG scaling process to capture any new Share VPC IP addresses assigned to new instances.
   - Document the new IPs for firewall updates.
4. **Update Firewall Rules**:
   - Add the new Share VPC IPs to the firewall whitelist using `gcloud compute firewall-rules update [RULE_NAME] --source-ranges=[NEW_IP_RANGE]` or via the GCP Console.
   - Specify relevant ports (e.g., 80, 443) and protocols (e.g., TCP) in the firewall rule.
5. **Document Changes**:
   - Record the updated MIG configuration, new instance counts, and firewall rule changes in the project documentation.

### Validation Methods
1. **Simulate Rolling Upgrade**:
   - Trigger a test rolling update using `gcloud compute instance-groups managed rolling-action start-update [MIG_NAME] --version=[NEW_IMAGE]`.
   - Monitor the update process to ensure no downtime occurs and all instances are replaced successfully.
2. **Verify Service Availability**:
   - Use load balancer health checks or external monitoring tools to confirm that the application remains accessible during the upgrade.
3. **Check Network Connectivity**:
   - Test connectivity to the new Share VPC IPs using tools like `curl` or `ping` from authorized networks.
   - Verify that firewall rules allow traffic to the new IPs on the specified ports.
4. **Monitor Metrics**:
   - Use Google Cloud Monitoring to track CPU, memory, and request latency metrics to ensure the adjusted MIG meets performance requirements.

### Notes
- **Backup**: Before making changes, back up the current MIG configuration (`gcloud compute instance-groups managed export [MIG_NAME]`) and firewall rules to enable quick rollback if needed.
- **Coordination**: Work closely with the network team to ensure timely updates to the firewall whitelist, preventing access issues due to unauthorized IPs.
- **Monitoring**: Continuously monitor MIG health and load balancer performance during and after the adjustment to detect any anomalies.
- **Testing Environment**: Perform the adjustment in a staging environment first, if available, to validate the process before applying it to production.
- **Communication**: Notify relevant stakeholders (e.g., application teams, operations) of the planned changes and potential impacts.

---

Let me know if you need further refinements, such as specific `gcloud` commands, example configurations, or additional details tailored to your environment!
