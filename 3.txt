以下是根据你描述的第二层 module 调用方式，搭配上次提供的 JSON 结构，所对应的**底层 module**（真正创建 spanner instance 和 IAM binding 的那个 module）的推荐写法：

### 底层 module 完整写法（假设路径为 `modules/spanner-instance`）

```hcl
# modules/spanner-instance/variables.tf

variable "project_id" {
  description = "GCP project id"
  type        = string
}

variable "name" {
  description = "Spanner instance name"
  type        = string
}

variable "config" {
  description = "Spanner instance config (regional-xxx or multi-region)"
  type        = string
}

variable "display_name" {
  description = "Display name of the instance"
  type        = string
  default     = null
}

variable "processing_units" {
  description = "Number of processing units (100 ~ 100000)"
  type        = number
  default     = 1000
}

variable "instance_iam_roles" {
  description = "Map of role -> list of members"
  type        = map(list(string))
  default     = {}
}

variable "labels" {
  description = "Optional labels"
  type        = map(string)
  default     = {}
}

# 可选：是否允许 terraform destroy 时强制删除（小心使用）
variable "force_destroy" {
  type    = bool
  default = false
}
```

```hcl
# modules/spanner-instance/main.tf

resource "google_spanner_instance" "this" {
  project          = var.project_id
  name             = var.name
  config           = var.config
  display_name     = coalesce(var.display_name, var.name)
  processing_units = var.processing_units
  labels           = var.labels
  force_destroy    = var.force_destroy

  # 可根据需要加入更多参数，例如 database encryption 等
}

# IAM 绑定 - 使用 authoritative binding (google_spanner_instance_iam_binding)
resource "google_spanner_instance_iam_binding" "roles" {
  for_each = var.instance_iam_roles

  project  = var.project_id
  instance = google_spanner_instance.this.name
  role     = each.key
  members  = each.value

  depends_on = [
    google_spanner_instance.this
  ]
}
```

### 第二层 module 的典型调用方式（参考你提供的结构）

```hcl
# 第二层 module 範例（例如 environments/dev/spanner.tf）

variable "spanner" {
  type = any
  # 或更嚴格一點：
  # type = map(object({
  #   config            = string
  #   display_name      = optional(string)
  #   processing_units  = optional(number, 1000)
  #   instance_iam_roles = optional(map(list(string)), {})
  #   labels            = optional(map(string), {})
  # }))
}

module "spanner_instances" {
  source   = "../../modules/spanner-instance"
  for_each = var.spanner

  project_id         = "my-project-123"
  name               = each.key
  config             = each.value.config
  display_name       = try(each.value.display_name, null)
  processing_units   = try(each.value.processing_units, 1000)
  instance_iam_roles = try(each.value.instance_iam_roles, {})
  labels             = try(each.value.labels, {})
  # force_destroy    = try(each.value.force_destroy, false)
}
```

### 对应 JSON / var.spanner 结构示例

```json
{
  "spanner": {
    "spanner-instance-1": {
      "config": "regional-us-central1",
      "display_name": "Spanner Instance 1",
      "processing_units": 1000,
      "instance_iam_roles": {
        "roles/spanner.databaseAdmin": [
          "group:gcp.project1.devops-team@abc.com"
        ]
      }
    },
    "spanner-instance-2": {
      "config": "regional-europe-west1",
      "display_name": "Spanner Instance 2",
      "processing_units": 2000,
      "instance_iam_roles": {
        "roles/spanner.viewer": [
          "user:example@abc.com"
        ],
        "roles/spanner.databaseUser": [
          "serviceAccount:sa@project.iam.gserviceaccount.com"
        ]
      }
    }
  }
}
```

### 总结目前推荐的命名方式对比

| 字段名                  | 上一版（扁平map）       | 本版（第二层 for_each）     | 建议使用哪个？         |
|-------------------------|--------------------------|------------------------------|------------------------|
| instance_iam_role       | 常用                     | —                            | —                      |
| instance_iam_roles      | —                        | 常用（复数更清晰）           | **推荐**（本版）       |
| 第二层 for_each key     | 整个实例map             | 实例名称                     | **本版更清晰**         |

**结论**：  
如果你决定采用第二层 `for_each = var.spanner` 的方式（每个实例一个 module 调用），那么**底层 module 建议使用 `instance_iam_roles`（复数）** 这个变量名，这样语义更清晰，也与社区大多数 spanner/terraform 模块的习惯更接近。

希望这个写法符合你的预期～
